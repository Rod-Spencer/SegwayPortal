using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Components;
using Segway_Portal.Models;
using Segway_Portal.Services;
using System.Security.Claims;

namespace Segway_Portal.Components.Pages
{
    public partial class Login : ComponentBase
    {
        ////////////////////////////////////////////////////////////////////////////////////////////////////
        #region Constructors
        #endregion
        ////////////////////////////////////////////////////////////////////////////////////////////////////


        ////////////////////////////////////////////////////////////////////////////////////////////////////
        #region Parameters
        #endregion Parameters
        ////////////////////////////////////////////////////////////////////////////////////////////////////


        ////////////////////////////////////////////////////////////////////////////////////////////////////
        #region Injections

        [Inject]
        public UserService_Interface? UserService { get; set; }

        [Inject]
        public NavigationManager? Nav { get; set; }

        [Inject]
        public IHttpContextAccessor? HttpContextAccessor { get; set; }


        #endregion Injections
        ////////////////////////////////////////////////////////////////////////////////////////////////////


        ////////////////////////////////////////////////////////////////////////////////////////////////////
        #region Private Properties

        private LoginModel model = new();
        private string? error;

        #endregion Private Properties
        ////////////////////////////////////////////////////////////////////////////////////////////////////


        ////////////////////////////////////////////////////////////////////////////////////////////////////
        #region Public Properties

        public String? UserName { get; set; }

        public String? Password { get; set; }

        public Boolean RememberMe { get; set; }

        #endregion Public Properties
        ////////////////////////////////////////////////////////////////////////////////////////////////////


        ////////////////////////////////////////////////////////////////////////////////////////////////////
        #region Screen State Properties
        #endregion Screen State Properties
        ////////////////////////////////////////////////////////////////////////////////////////////////////


        ////////////////////////////////////////////////////////////////////////////////////////////////////
        #region Override Methods
        #endregion Override Methods
        ////////////////////////////////////////////////////////////////////////////////////////////////////


        ////////////////////////////////////////////////////////////////////////////////////////////////////
        #region Protected Methods
        #endregion
        ////////////////////////////////////////////////////////////////////////////////////////////////////


        ////////////////////////////////////////////////////////////////////////////////////////////////////
        #region Public Methods
        #endregion
        ////////////////////////////////////////////////////////////////////////////////////////////////////


        ////////////////////////////////////////////////////////////////////////////////////////////////////
        #region Private Methods

        private async Task HandleLogin()
        {
            error = null;
            if (string.IsNullOrEmpty(UserName) || string.IsNullOrEmpty(Password))
            {
                error = "Please enter both username and password.";
                return;
            }

            if (UserService is null)
            {
                error = "User service is not available.";
                return;
            }

            var user = await UserService.ValidateUserAsync(UserName, Password);

            if (user == null)
            {
                error = "Invalid username or password.";
                return;
            }

            if (HttpContextAccessor?.HttpContext is null)
            {
                error = "HTTP context is not available.";
                return;
            }

            if (Nav is null)
            {
                error = "Navigation service is not available.";
                return;
            }

            var claims = new List<Claim>
            {
                new Claim(ClaimTypes.Name, user.User_Name),
                new Claim("UserId", user.ID.ToString())
            };

            var identity = new ClaimsIdentity(claims, "Cookies");
            var principal = new ClaimsPrincipal(identity);

            await HttpContextAccessor.HttpContext.SignInAsync("Cookies", principal);

            Nav.NavigateTo("/Tools");
        }


        #endregion
        ////////////////////////////////////////////////////////////////////////////////////////////////////
    }

}
